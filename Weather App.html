<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>Weather App — Public API (Open-Meteo)</title>

    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 24px;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: #0b1020;
        color: #e9eefc;
      }

      .app {
        max-width: 980px;
        margin: 0 auto;
      }

      /*  Card container style (reused in UI blocks) */
      .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: 16px;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }

      h1 {
        font-size: 18px;
        margin: 0 0 10px;
      }

      .muted {
        opacity: 0.75;
      }

      input {
        flex: 1; /* ✅ take remaining width */
        width: 100%;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.16);
        color: #e9eefc;
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
        min-width: 220px; /* ✅ prevents being too small */
      }

      button {
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
        background: #4f7cff;
        color: white;
        font-weight: 800;
      }

      button.secondary {
        background: rgba(255, 255, 255, 0.12);
      }

      /*  Disabled buttons look inactive */
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        margin-top: 10px;
        display: none; /*  shown only while loading */
        align-items: center;
        gap: 10px;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.25);
        border-top-color: white; /* ✅ visible rotating top */
        animation: spin 0.85s linear infinite;
      }

      /* ✅ Animation definition for spinner */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      /* ✅ On small screens, stack cards vertically */
      @media (max-width: 860px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .big {
        font-size: 42px;
        font-weight: 900;
        line-height: 1;
        margin: 10px 0 6px;
      }

      .pill {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.14);
        margin-right: 6px;
        margin-top: 6px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      th,
      td {
        text-align: left;
        padding: 10px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 14px;
      }

      th {
        opacity: 0.85;
        font-weight: 800;
      }

      tr:last-child td {
        border-bottom: none;
      }

      .error {
        display: none;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 79, 109, 0.45);
        background: rgba(255, 79, 109, 0.12);
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="card">
        <h1>Weather App (Public API)</h1>
        <div class="muted">
          Search any city → get current weather + 7-day forecast.
        </div>

        <div class="row" style="margin-top: 12px">
          <input
            id="city"
            placeholder="Type a city… (e.g., Amman, London, Tokyo)" />
          <button id="btnSearch">Search</button>
          <button id="btnUseAmman" class="secondary">Use Amman</button>
        </div>

        <div class="status muted" id="loading">
          <div class="spinner"></div>
          <div>Loading…</div>
        </div>

        <div class="error" id="error"></div>

        <div class="grid" id="results" style="display: none">
          <!-- ✅ Current weather card -->
          <div class="card">
            <strong id="placeName">—</strong>
            <div class="muted" id="placeMeta" style="margin-top: 6px">—</div>

            <div class="big" id="tempNow">—</div>

            <div>
              <span class="pill" id="humidityPill">Humidity: —</span>
              <span class="pill" id="windPill">Wind: —</span>
            </div>

            <div class="muted" id="timeMeta" style="margin-top: 10px">—</div>
          </div>

          <!-- ✅ 7-day forecast table card -->
          <div class="card">
            <strong>7-Day Forecast</strong>
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Min</th>
                  <th>Max</th>
                  <th>Rain</th>
                </tr>
              </thead>
              <tbody id="forecastBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // =========================================================
      //  API Endpoints (Open-Meteo)
      // =========================================================
      // ✅ Geocoding: city name → lat/lon
      const GEO_URL = "https://geocoding-api.open-meteo.com/v1/search";

      // ✅ Forecast: lat/lon → current + daily forecast
      const FC_URL = "https://api.open-meteo.com/v1/forecast";

      const UI = {
        // Search controls
        city: document.getElementById("city"),
        btnSearch: document.getElementById("btnSearch"),
        btnUseAmman: document.getElementById("btnUseAmman"),

        // UI state areas
        loading: document.getElementById("loading"),
        error: document.getElementById("error"),
        results: document.getElementById("results"),

        // Current weather display
        placeName: document.getElementById("placeName"),
        placeMeta: document.getElementById("placeMeta"),
        tempNow: document.getElementById("tempNow"),
        humidityPill: document.getElementById("humidityPill"),
        windPill: document.getElementById("windPill"),
        timeMeta: document.getElementById("timeMeta"),

        // Forecast table body
        forecastBody: document.getElementById("forecastBody"),
      };

      // =========================================================
      //App State
      // ---------------------------------------------------------

      let currentController = null;

      function setLoading(isLoading) {
        UI.loading.style.display = isLoading ? "flex" : "none";
        UI.btnSearch.disabled = isLoading;
        UI.btnUseAmman.disabled = isLoading;
      }

      function setError(message) {
        if (!message) {
          UI.error.style.display = "none";
          UI.error.textContent = "";
          return;
        }

        // ✅ Else show it
        UI.error.style.display = "block";
        UI.error.textContent = message;
      }

      async function apiFetchJson(url, signal) {
        const res = await fetch(url, { signal });

        if (!res.ok) throw new Error(`HTTP ${res.status} (${res.statusText})`);

        return res.json();
      }

      async function geocodeCity(name, signal) {
        const url = new URL(GEO_URL);

        url.searchParams.set("name", name);
        url.searchParams.set("count", "1");
        url.searchParams.set("language", "en");
        url.searchParams.set("format", "json");

        const data = await apiFetchJson(url, signal);

        if (!data.results || data.results.length === 0) {
          throw new Error(`City not found: ${name}`);
        }

        return data.results[0];
      }

      async function getForecast(lat, lon, signal) {
        const url = new URL(FC_URL);

        // ✅ Coordinates
        url.searchParams.set("latitude", String(lat));
        url.searchParams.set("longitude", String(lon));

        // ✅ Current weather fields
        url.searchParams.set(
          "current",
          "temperature_2m,relative_humidity_2m,wind_speed_10m",
        );

        // ✅ 7-day daily summary fields
        url.searchParams.set(
          "daily",
          "temperature_2m_min,temperature_2m_max,precipitation_sum",
        );

        // ✅ API returns local time based on coordinates
        url.searchParams.set("timezone", "auto");

        // ✅ Call API and return JSON
        return apiFetchJson(url, signal);
      }

      // =========================================================
      // ✅ Render (Put results into the UI)
      // =========================================================
      function render(place, data) {
        // ✅ Show results section
        UI.results.style.display = "grid";

        // ✅ City name + country
        UI.placeName.textContent = `${place.name}, ${place.country}`;

        // ✅ Show coordinates for transparency/debugging
        UI.placeMeta.textContent = `Lat/Lon: ${place.latitude}, ${place.longitude}`;

        // ✅ Current temperature + its unit (°C, °F)
        const t = data.current.temperature_2m;
        const tUnit = data.current_units.temperature_2m;
        UI.tempNow.textContent = `${t}${tUnit}`;

        // ✅ Humidity pill (includes unit %)
        UI.humidityPill.textContent = `Humidity: ${data.current.relative_humidity_2m}${data.current_units.relative_humidity_2m}`;

        // ✅ Wind pill (includes unit like km/h)
        UI.windPill.textContent = `Wind: ${data.current.wind_speed_10m} ${data.current_units.wind_speed_10m}`;

        // ✅ Current local time of city (from API)
        UI.timeMeta.textContent = `Local time: ${data.current.time} (${data.timezone})`;

        // ✅ Build forecast table rows from daily arrays
        const days = data.daily.time;

        UI.forecastBody.innerHTML = days
          .map((day, i) => {
            // ✅ Each index i represents same day across arrays
            const min = data.daily.temperature_2m_min[i];
            const max = data.daily.temperature_2m_max[i];
            const rain = data.daily.precipitation_sum[i];

            // ✅ Units (usually °C, mm)
            const minU = data.daily_units.temperature_2m_min;
            const maxU = data.daily_units.temperature_2m_max;
            const rainU = data.daily_units.precipitation_sum;

            // ✅ Return table row HTML
            return `
          <tr>
            <td>${day}</td>
            <td>${min}${minU}</td>
            <td>${max}${maxU}</td>
            <td>${rain} ${rainU}</td>
          </tr>
        `;
          })
          .join("");
      }

      async function runSearch(cityName) {
        // ✅ Cancel previous request if it exists
        // This prevents old results overwriting new ones
        if (currentController) currentController.abort();

        // ✅ Create a new AbortController for this new search
        currentController = new AbortController();

        // ✅ Reset UI state
        setError("");
        setLoading(true);

        try {
          // ✅ 1) City name → place object (lat/lon/country)
          const place = await geocodeCity(cityName, currentController.signal);

          // ✅ 2) lat/lon → weather data
          const data = await getForecast(
            place.latitude,
            place.longitude,
            currentController.signal,
          );

          // ✅ 3) Render results to UI
          render(place, data);
        } catch (err) {
          // ✅ AbortError means we canceled the request on purpose (not a real failure)
          if (err.name === "AbortError") return;

          // ✅ Show error message
          setError(`❌ ${err.message}`);

          // ✅ Hide results if error happens (so old results don't remain visible)
          UI.results.style.display = "none";
        } finally {
          // ✅ Always stop loading spinner (success OR failure)
          setLoading(false);
        }
      }

      // ✅ Search button click
      UI.btnSearch.addEventListener("click", () => {
        const name = UI.city.value.trim();

        // ✅ Simple validation: city must not be empty
        if (!name) return setError("❌ Please enter a city name.");

        runSearch(name);
      });

      // ✅ Pressing Enter in the input triggers search
      UI.city.addEventListener("keydown", (e) => {
        if (e.key === "Enter") UI.btnSearch.click();
      });

      // ✅ Quick demo button: instantly search for Amman
      UI.btnUseAmman.addEventListener("click", () => {
        UI.city.value = "Amman";
        runSearch("Amman");
      });

      // =========================================================
      // Auto-run (Initial Demo on Page Load)
      // =========================================================
      UI.city.value = "Amman";
      runSearch("Amman");
    </script>
  </body>
</html>
